<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HireMe - User Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9; /* Light blue/gray background */
        }
        input:required:invalid {
            border-color: #ef4444; /* Tailwind red-500 */
        }
        .full-screen-viewer {
            width: 100%;
            height: 600px; 
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            margin-top: 1rem;
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col items-center justify-center min-h-screen py-8">

    <div class="container mx-auto px-4 max-w-5xl space-y-8">
        
        <header class="flex justify-between items-center mb-6 p-4 bg-white rounded-2xl shadow-xl">
             <h1 class="text-4xl font-extrabold text-indigo-700 tracking-tight">HireMe Career Portal</h1>
             <button id="logoutBtn" onclick="logoutUser()" class="py-2 px-5 bg-red-600 text-white text-sm font-semibold rounded-full shadow-lg hover:bg-red-700 transition duration-300 hidden">
                Logout
            </button>
        </header>

        <!-- Global Message Display -->
        <div id="messageBox" class="p-4 bg-gray-100 rounded-lg text-center text-sm font-medium text-gray-600 shadow-inner">
            Checking authentication status...
        </div>

        <!-- 1. AUTHENTICATION SCREEN (Login/Signup) -->
        <div id="authScreen" class="max-w-xl mx-auto space-y-10">
            <div class="p-8 text-center bg-indigo-50 rounded-xl border border-indigo-300 shadow-md">
                <h2 class="text-3xl font-bold text-indigo-700 mb-2">Login or Sign Up</h2>
                <p class="text-gray-600 text-lg">Access your profile and resume tools.</p>
            </div>

            <!-- LOGIN FORM -->
            <div id="loginContainer" class="p-8 border border-gray-200 rounded-xl bg-gray-50 space-y-6 shadow-lg">
                <h3 class="text-2xl font-bold text-gray-800">Log In</h3>
                <form id="loginForm" class="space-y-5">
                    <div>
                        <label for="loginUsername" class="block text-sm font-medium text-gray-700">Username</label>
                        <input type="text" id="loginUsername" name="user_name" placeholder="Enter your username" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm sm:text-base p-3 focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                    <div>
                        <label for="loginPassword" class="block text-sm font-medium text-gray-700">Password</label>
                        <input type="password" id="loginPassword" name="password" placeholder="Enter your password" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm sm:text-base p-3 focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                    <div>
                        <label for="loginUserType" class="block text-sm font-medium text-gray-700">Select Role</label>
                        <select id="loginUserType" name="user_type" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm sm:text-base p-3" required>
                            <option value="JOB_SEEKER">Job Seeker</option>
                            <option value="COMPANY">Company / Recruiter</option>
                            <option value="ADVERTISER">Advertiser</option>
                        </select>
                    </div>
                    <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-md text-base font-semibold text-white bg-indigo-600 hover:bg-indigo-700 transition duration-300">
                        Log In
                    </button>
                </form>

               
            </div>

            <!-- SIGNUP FORM (Hidden by default) -->
            <div id="signupContainer" class="p-8 border border-green-300 rounded-xl bg-green-50 space-y-6 shadow-lg hidden">
                <h3 class="text-2xl font-bold text-green-700">New User Signup</h3>
                <form id="signupForm" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="text" id="signupUsername" name="user_name" placeholder="Username" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3" required>
                        <input type="password" id="signupPassword" name="password" placeholder="Password" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3" required>
                        <input type="text" id="signupFirstName" name="first_name" placeholder="First Name" class="mt-1 block w-full px-3 py-3 border border-gray-300 rounded-lg shadow-sm">
                        <input type="text" id="signupLastName" name="last_name" placeholder="Last Name" class="mt-1 block w-full px-3 py-3 border border-gray-300 rounded-lg shadow-sm">
                        <input type="tel" id="signupMobileNumber" name="mobile_number" placeholder="Mobile Number (Mandatory)" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3" required>
                        <input type="email" id="signupEmail" name="email" placeholder="Email (Mandatory)" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3" required>
                        <input type="date" id="signupDOB" name="date_of_birth" placeholder="Date of Birth" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3">
                        <select id="signupUserType" name="user_type" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3" required>
                            <option value="JOB_SEEKER">Sign up as Job Seeker</option>
                            <option value="COMPANY">Sign up as Company</option>
                            <option value="ADVERTISER">Sign up as Advertiser</option>
                        </select>
                        <select id="signupMembership" name="membershipDays" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3">
                            <option value="0">Free Trial (0 Days)</option>
                            <option value="15">Premium (15 Days)</option>
                            <option value="30">Premium (30 Days)</option>
                            <option value="90">Premium (90 Days)</option>
                            <option value="365">Premium (365 Days)</option>
                        </select>
                    </div>
                    <!-- NEW DYNAMIC FIELDS CONTAINER -->
                        <div id="companyFields" class="company-fields-group">
                            <input type="text" id="signupCompanyName" name="company_name" placeholder="Company Name (Required)" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3">
                        </div>
                        <div id="gstFields" class="company-fields-group">
                            <input type="text" id="signupGstNumber" name="gst_number" placeholder="GST / Registration ID (Required)" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3">
                        </div>
                    <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-md text-base font-semibold text-white bg-green-600 hover:bg-green-700 transition duration-300">
                        Sign Up & Log In
                    </button>
                </form>
            </div>
             <hr class="my-6 border-gray-300">

                <div class="text-center">
                    <p class="text-sm text-gray-600 mb-3">Don't have an account?</p>
                    <button type="button" id="toggleSignupBtn" class="py-2 px-6 border border-green-600 text-sm font-semibold rounded-full text-green-600 hover:bg-green-100 transition duration-300">
                        Show Signup Form
                    </button>
            </div>
        </div>

        <!-- 2. DASHBOARD SCREEN -->
        <div id="dashboardScreen" class="space-y-8 hidden">
            
            <!-- Dynamic Dashboard Header -->
            <div class="p-8 text-center bg-white rounded-2xl border shadow-xl" id="dashboardHeader">
                <h2 class="text-3xl font-extrabold text-gray-800 mb-2" id="dashboardTitle"></h2>
                <p class="text-gray-600 text-lg mb-2" id="dashboardSubtitle"></p>
                <div class="flex justify-center items-center space-x-4 mt-2">
                    <p class="text-sm font-medium text-indigo-600">User: <span id="currentUsernameDisplay" class="font-bold"></span> (<span id="dashboardUserId" class="text-gray-500"></span>)</p>
                    <span id="paidStatusBadge" class="px-3 py-1 text-xs font-bold rounded-full"></span>
                </div>
            </div>

            <!-- Dashboard Content Wrapper (Will be loaded/controlled by JS based on role) -->
            <div id="dashboardContent" class="space-y-8">
                <!-- Content injected here based on role (Job Seeker / Company / Advertiser) -->
            </div>
        </div>

    </div>

    <script>
        const API_URL = 'http://localhost:8080';
        
        // --- GLOBAL STATE ---
        let currentUserId = localStorage.getItem('currentUserId') ? parseInt(localStorage.getItem('currentUserId')) : null;
        let currentUsername = localStorage.getItem('currentUsername') || null;
        let currentUserRole = localStorage.getItem('currentUserRole') || null;
        let currentMembershipDays = parseInt(localStorage.getItem('currentMembershipDays')) || 0;
        let currentIsPaidMember = currentMembershipDays > 0;

        // Global state to hold the uploaded file data for immediate analysis (for Job Seeker)
        window.lastUploadedBase64 = null;
        window.lastUploadedMimeType = null;


        const messageBox = document.getElementById('messageBox');
        const logoutBtn = document.getElementById('logoutBtn');
        const authScreen = document.getElementById('authScreen');
        const dashboardScreen = document.getElementById('dashboardScreen');
        const signupContainer = document.getElementById('signupContainer');
        const loginContainer = document.getElementById('loginContainer');

        // Global Message Function
        function showMessage(text, type = 'info') {
            messageBox.textContent = text;
            messageBox.className = 'p-4 rounded-lg text-center text-sm font-medium shadow-inner';
            if (type === 'success') messageBox.classList.add('bg-green-100', 'text-green-800');
            else if (type === 'error') messageBox.classList.add('bg-red-100', 'text-red-800');
            else messageBox.classList.add('bg-blue-100', 'text-blue-800');
        };

        // --- CORE AUTH AND STATE MANAGEMENT ---

        function updateDashboardHeader(role, isPaid, days) {
            const titleElement = document.getElementById('dashboardTitle');
            const subtitleElement = document.getElementById('dashboardSubtitle');
            const badgeElement = document.getElementById('paidStatusBadge');

            document.getElementById('currentUsernameDisplay').textContent = currentUsername;
            document.getElementById('dashboardUserId').textContent = `(ID: ${currentUserId})`;

            badgeElement.classList.remove('bg-green-600', 'text-white', 'bg-gray-200', 'text-gray-700');

            if (isPaid && days > 0) {
                badgeElement.textContent = `PREMIUM ACCESS (${days} Days)`;
                badgeElement.classList.add('bg-green-600', 'text-white');
            } else {
                badgeElement.textContent = `FREE TIER`;
                badgeElement.classList.add('bg-gray-200', 'text-gray-700');
            }

            switch (role) {
                case 'JOB_SEEKER':
                    titleElement.textContent = "Job Seeker Dashboard";
                    subtitleElement.textContent = "Manage your resume and track profile activity.";
                    loadJobSeekerDashboard();
                    break;
                case 'COMPANY':
                    titleElement.textContent = "Recruiter Dashboard";
                    subtitleElement.textContent = "Manage job listings and search candidates.";
                    loadCompanyDashboard();
                    break;
                case 'ADVERTISER':
                    titleElement.textContent = "Advertiser Console";
                    subtitleElement.textContent = "Manage campaigns and monitor performance.";
                    loadAdvertiserDashboard();
                    break;
                default:
                    titleElement.textContent = "Welcome";
                    subtitleElement.textContent = "Access Denied: Unknown role.";
                    document.getElementById('dashboardContent').innerHTML = `<p class="text-center text-red-500">Access role not recognized.</p>`;
            }
        }
        
        function checkAuth() {
            if (currentUserId && currentUsername && currentUserRole) {
                authScreen.classList.add('hidden');
                dashboardScreen.classList.remove('hidden');
                logoutBtn.classList.remove('hidden');
                
                // Initialize Dashboard based on role
                updateDashboardHeader(currentUserRole, currentIsPaidMember, currentMembershipDays);
            } else {
                authScreen.classList.remove('hidden');
                dashboardScreen.classList.add('hidden');
                logoutBtn.classList.add('hidden');
                 // FIX: Ensure login is visible and signup is hidden when starting logged out
                if (loginContainer && signupContainer) {
                    loginContainer.classList.remove('hidden');
                    signupContainer.classList.add('hidden');
                    // Ensure the button text reflects the state
                    document.getElementById('toggleSignupBtn').textContent = 'Show Signup Form';
                }
                
                showMessage('Please sign up or log in to continue.', 'info');
            }
        }

        function loginUser(id, username, role, isPaid, membershipDays) {
            console.log('Logging in user:', {id, username, role, isPaid, membershipDays});
            if (isNaN(parseInt(id)) || parseInt(id) <= 0) return showMessage('Invalid User ID provided.', 'error');
            
            localStorage.setItem('currentUserId', id);
            localStorage.setItem('currentUsername', username);
            localStorage.setItem('currentUserRole', role);
            localStorage.setItem('currentMembershipDays', membershipDays);

            currentUserId = id;
            currentUsername = username;
            currentUserRole = role;
            currentMembershipDays = membershipDays;
            currentIsPaidMember = isPaid;

            showMessage(`Welcome back, ${username} (${role})! Logged in successfully.`, 'success');
            checkAuth();
        }

        function logoutUser() {
            localStorage.clear();
            currentUserId = null;
            currentUsername = null;
            currentUserRole = null;
            currentIsPaidMember = false;
            currentMembershipDays = 0;
            // Clear local file state
            window.lastUploadedBase64 = null;
            window.lastUploadedMimeType = null;
            checkAuth();
        }

        function toggleSignupFields(role) {
            const isCompanyOrAdvertiser = (role === 'COMPANY' || role === 'ADVERTISER');
            
            const companyFields = document.getElementById('companyFields');
            const gstFields = document.getElementById('gstFields');
            const companyNameInput = document.getElementById('signupCompanyName');
            const gstNumberInput = document.getElementById('signupGstNumber');
            
            // Toggle Visibility
            companyFields.style.display = isCompanyOrAdvertiser ? 'block' : 'none';
            gstFields.style.display = isCompanyOrAdvertiser ? 'block' : 'none';
            
            // Toggle Mandatory Status (The required attribute is crucial for browser validation)
            companyNameInput.required = isCompanyOrAdvertiser;
            gstNumberInput.required = isCompanyOrAdvertiser;
            
            // Ensure inputs are cleared if they are hidden to avoid sending invalid data
            if (!isCompanyOrAdvertiser) {
                 companyNameInput.value = '';
                 gstNumberInput.value = '';
            }
        }
        // Attach field toggle listener on load
        document.addEventListener('DOMContentLoaded', () => {
            const signupRoleSelect = document.getElementById('signupRole');
            if (signupRoleSelect) {
                signupRoleSelect.addEventListener('change', (e) => toggleSignupFields(e.target.value));
                // Initial check
                toggleSignupFields(signupRoleSelect.value);
            }
            checkAuth();
        });

        function toggleSignupForm() {
            const isHidden = signupContainer.classList.contains('hidden');
            
            // Toggle visibility of the signup form container
            signupContainer.classList.toggle('hidden', !isHidden);
            
            // Toggle visibility of the login form container (The FIX)
            loginContainer.classList.toggle('hidden', isHidden); 
            
            document.getElementById('toggleSignupBtn').textContent = isHidden ? 'Hide Signup Form' : 'Show Signup Form';
            
            // Reset fields on toggle
            document.getElementById('signupForm').reset();
            toggleSignupFields('JOB_SEEKER'); // Default to hiding company fields
        }

        document.getElementById('toggleSignupBtn').addEventListener('click', toggleSignupForm);
        
        // --- DYNAMIC DASHBOARD LOADERS ---

        function loadJobSeekerDashboard() {
            const content = `
                <!-- Job Seeker Dashboard Content -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- 1. Resume Status Card -->
                    <div class="p-6 bg-yellow-50 rounded-xl border border-yellow-300 shadow-md">
                        <h3 class="text-xl font-bold text-yellow-700 mb-3 flex items-center">Resume Status</h3>
                        <div id="resumeStatusContent" class="text-sm text-gray-600 space-y-2">
                            <p>Status: <span id="currentResumeStatus" class="font-bold text-red-600">Not Uploaded</span></p>
                            <p>File: <span id="currentFilenameSummary">N/A</span></p>
                            <p>Last Update: <span id="currentUploadTimeSummary">N/A</span></p>
                        </div>
                    </div>

                    <!-- 2. Profile Views Counter (Simulated) -->
                    <div class="p-6 bg-white rounded-xl border border-gray-200 shadow-md">
                        <h3 class="text-xl font-bold text-gray-700 mb-3 flex items-center">Total Profile Views</h3>
                        <p class="text-5xl font-extrabold text-green-600"><span id="viewCount">24</span></p>
                        <p class="text-sm text-gray-500 mt-2">Companies checked your profile this month (Simulated).</p>
                    </div>

                    <!-- 3. AI Summary Card -->
                    <div class="p-6 bg-indigo-50 rounded-xl border border-indigo-300 shadow-md">
                        <h3 class="text-xl font-bold text-indigo-700 mb-3 flex items-center">AI Resume Summary</h3>
                        <div id="aiAnalysisResult" class="text-gray-700 text-sm space-y-3">
                            <p class="font-medium text-gray-500" id="aiStatus">Status: Awaiting upload.</p>
                            <button id="analyzeResumeBtn" onclick="analyzeResumeWithAI()" class="mt-2 w-full py-2 px-4 text-white bg-indigo-600 rounded-md hover:bg-indigo-700 transition-colors shadow-md text-sm disabled:opacity-50" disabled>
                                Analyze Resume (AI)
                            </button>
                            <div id="summaryContent" class="mt-4 text-sm bg-indigo-100 p-3 rounded-lg hidden"></div>
                        </div>
                    </div>
                </div>
                
                <hr class="my-8 border-gray-200">

                <!-- RESUME MANAGER SECTION -->
                <div id="resumeManagerSection" class="p-8 bg-white rounded-2xl shadow-xl border border-yellow-400/50 space-y-6">
                    <h3 class="text-2xl font-bold text-yellow-800 border-b pb-3 flex items-center">Resume Upload & Viewer</h3>
                    
                    <div id="currentResumeInfo" class="space-y-4 p-5 border border-gray-200 rounded-xl bg-white shadow-sm">
                    <h4 class="text-xl font-semibold text-gray-700">Preview & Download</h4>
                    <div class="flex space-x-4">
                        <button id="viewResumeBtn" class="py-2 px-4 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg shadow-md transition duration-150">
                            View Resume in Browser
                        </button>
                        <button id="downloadResumeBtn" class="py-2 px-4 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-lg shadow-md transition duration-150">
                            Download File
                        </button>
                    </div>
                </div>
                    
                    <form id="resumeUploadForm" class="space-y-4 p-5 border border-yellow-200 rounded-xl bg-yellow-50 shadow-inner">
                        <h4 class="text-xl font-semibold text-gray-700">Upload New Resume (.PDF, .DOC, .DOCX)</h4>
                        <label for="resumeFile" class="block text-sm font-medium text-gray-700">Select File (Max 4MB):</label>
                        <input type="file" id="resumeFile" accept=".pdf,.doc,.docx,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document" required class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-lg shadow-sm">
                        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-5 rounded-lg shadow-md transition duration-150">
                            Upload & Replace Current Resume
                        </button>
                    </form>

                    <div id="resumeViewerContainer" class="hidden">
                        <p class="text-sm font-medium text-gray-700 mb-2">Resume Preview (Streamed from Server):</p>
                        <embed id="resumeViewer" src="" class="full-screen-viewer" type="application/pdf">
                    </div>
                </div>
            `;
            document.getElementById('dashboardContent').innerHTML = content;
            // Re-attach listeners for the JS Seeker dashboard
            document.getElementById('resumeUploadForm').addEventListener('submit', handleResumeUpload);
            updateDashboardResumeSection(currentUserId);
        }

        function loadCompanyDashboard() {
            const paidText = currentIsPaidMember ? "PREMIUM: Access to full contact details." : "FREE TIER: Contact details are masked.";
            const content = `
                <!-- Company Dashboard Content -->
                <div class="space-y-8">
                    <!-- Job Listing Management -->
                    <div class="p-8 bg-white rounded-2xl shadow-xl border border-indigo-400/50 space-y-6">
                        <h3 class="text-2xl font-bold text-indigo-700 border-b pb-3">Job Management (CRUD)</h3>
                        <p class="text-sm text-gray-600">${paidText}</p>
                        <button class="py-2 px-4 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700">
                            + Create New Job Listing
                        </button>
                        <div class="mt-4 p-4 border border-gray-200 rounded-lg">
                            <h4 class="font-semibold">Simulated Active Jobs:</h4>
                            <ul class="list-disc list-inside text-gray-700 text-sm mt-2">
                                <li>Senior Go Developer (40 applicants)</li>
                                <li>Product Manager, GenAI (12 applicants)</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Candidate Search Section -->
                    <div class="p-8 bg-white rounded-2xl shadow-xl border border-green-400/50 space-y-6">
                        <h3 class="text-2xl font-bold text-green-700 border-b pb-3">Candidate Search & Matching</h3>
                        
                        <form id="candidateSearchForm" class="space-y-4">
                            <input type="text" id="searchKeywords" placeholder="Enter required skills (e.g., Kubernetes, Python, 5 years)" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3" required>
                            <button type="submit" class="w-full py-2 px-4 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700">
                                Search Matching Resumes (Elastic)
                            </button>
                        </form>

                        <div id="candidateResults" class="mt-6 space-y-4">
                            <!-- Simulated Search Results -->
                            <h4 class="font-bold text-gray-700">Top Matches (Simulated):</h4>
                            <div class="p-4 border rounded-lg bg-gray-50 space-y-2">
                                <p class="font-semibold text-lg">Candidate 1: Senior DevOps Engineer</p>
                                <p class="text-sm text-gray-700">**Skills:** Go, Docker, AWS, Terraform.</p>
                                <p class="text-sm text-red-600">Contact: [Masked: Upgrade to Premium]</p>
                                ${currentIsPaidMember ? `
                                    <p class="text-sm text-green-700">**Contact:** John Doe, 555-1234, john.d@email.com</p>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('dashboardContent').innerHTML = content;
            // Attach form handler (simulated search)
            document.getElementById('candidateSearchForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const keywords = document.getElementById('searchKeywords').value;
                const resultsDiv = document.getElementById('candidateResults');
                resultsDiv.innerHTML = `<p class="text-center text-blue-600">Searching for resumes matching "${keywords}"...</p>`;
                
                // Simulate fetching and displaying tiered data
                setTimeout(() => {
                    const paidContact = currentIsPaidMember ? `<p class="text-sm text-green-700 font-bold">**Contact:** Alice Smith, 555-9876, alice.s@email.com</p>` : `<p class="text-sm text-red-600 font-bold">Contact: [Masked: Upgrade to Premium]</p>`;
                    resultsDiv.innerHTML = `
                        <h4 class="font-bold text-gray-700">Top Matches (Simulated):</h4>
                        <div class="p-4 border rounded-lg bg-gray-50 space-y-2">
                            <p class="font-semibold text-lg">Candidate 2: Full Stack Developer</p>
                            <p class="text-sm text-gray-700">**Skills:** React, Python, AWS Lambda.</p>
                            ${paidContact}
                        </div>
                        <div class="p-4 border rounded-lg bg-gray-50 space-y-2">
                            <p class="font-semibold text-lg">Candidate 3: Senior Product Manager</p>
                            <p class="text-sm text-gray-700">**Skills:** Product Management, Jira, Agile.</p>
                            ${paidContact}
                        </div>
                    `;
                }, 1500);
            });
        }
        
        function loadAdvertiserDashboard() {
            const content = `
                <!-- Advertiser Dashboard Content -->
                <div class="p-8 bg-white rounded-2xl shadow-xl border border-purple-400/50 space-y-6">
                    <h3 class="text-2xl font-bold text-purple-700 border-b pb-3">Campaign Management Console</h3>
                    <p class="text-sm text-gray-600">Manage ad placements targeting Job Seekers and Companies.</p>
                    <div class="grid grid-cols-2 gap-4 text-center">
                        <div class="p-4 bg-purple-50 rounded-lg border">
                            <p class="text-4xl font-extrabold text-purple-600">5</p>
                            <p class="text-sm text-gray-700">Active Campaigns</p>
                        </div>
                        <div class="p-4 bg-purple-50 rounded-lg border">
                            <p class="text-4xl font-extrabold text-purple-600">8.2%</p>
                            <p class="text-sm text-gray-700">Average CTR</p>
                        </div>
                    </div>
                    <button class="w-full py-2 px-4 bg-purple-600 text-white font-semibold rounded-lg shadow-md hover:bg-purple-700">
                        View Analytics & Reports
                    </button>
                </div>
            `;
            document.getElementById('dashboardContent').innerHTML = content;
        }

        // --- API HANDLERS (Simplified for Monolithic File) ---

        // Helper Function to get form data
        function getAuthFormData(formId) {
            const form = document.getElementById(formId);
            const data = {};
            new FormData(form).forEach((value, key) => {
                data[key] = value.trim();
            });
            return data;
        }

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            showMessage('Attempting login...', 'info');
            const user_name = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            const user_type = document.getElementById('loginUserType').value; // Get selected role

            try {
                // Simulate API Call: You would send user_name and password
                // The Go backend would authenticate and return the full user data (including role and membership status)
                const response = await fetch(`${API_URL}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_name: user_name, password: password, user_type: user_type })
                });
                const data = await response.json();

                if (response.ok) {
                    // --- SIMULATION of BACKEND RESPONSE ---
                    // Assuming the backend returns: { user_id, user_name, user_role, is_paid_member, membership_days }
                    const simulatedMembership = (user_name === 'premium_company' && user_type === 'COMPANY') ? 90 : 0;
                    
                    const backendData = {
                        user_id: data.user_id || 101, 
                        user_name: user_name,
                        user_type: user_type, 
                        is_paid_member: (simulatedMembership > 0),
                        membership_days: simulatedMembership,
                    };
                    // --- END SIMULATION ---

                    loginUser(backendData.user_id, backendData.user_name, backendData.user_type, backendData.is_paid_member, backendData.membership_days);
                } else {
                    showMessage(`Login Error: ${data.message || 'Invalid credentials or server error.'}`, 'error');
                }
            } catch (error) {
                console.error('Login failed:', error);
                showMessage('Network error during login. Check Go server and CORS.', 'error');
            }
        });

        document.getElementById('signupForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            showMessage('Signing up user...', 'info');
            const requestBody = getAuthFormData('signupForm');
            
            // Extract role and membership days for client state update
            const user_type = document.getElementById('signupUserType').value;
            const membershipDays = parseInt(document.getElementById('signupMembership').value);
            // Validation is now done primarily by the browser using the `required` attribute.
            // However, this manual check remains a good secondary layer:
            if ((user_type === 'COMPANY' || user_type === 'ADVERTISER') && (!requestBody.companyName || !requestBody.gstNumber)) {
                showMessage('Company Name and GST/Registration ID are required for this role.', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/signup`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });
                const data = await response.json();

                if (response.ok) {
                    // Assuming the Go server returns { "id": 123 }
                    const isPaid = membershipDays > 0;
                    loginUser(data.user_id, requestBody.user_name, user_type, isPaid, membershipDays);
                } else {
                    showMessage(`Signup Error: ${data.message || 'Failed to sign up. Username or email may be taken.'}`, 'error');
                }
            } catch (error) {
                console.error('Signup failed:', error);
                showMessage('Network error during signup. Check Go server and CORS.', 'error');
            }
        });

        // --- RESUME UPLOAD/ANALYSIS LOGIC (Used by Job Seeker Dashboard) ---
        
        async function updateDashboardResumeSection(userID) {
            // NOTE: These elements only exist after loadJobSeekerDashboard runs
            const statusSpan = document.getElementById('currentResumeStatus');
            const infoDiv = document.getElementById('currentResumeInfo');
            const analyzeBtn = document.getElementById('analyzeResumeBtn');
            const viewerContainer = document.getElementById('resumeViewerContainer');

            if (!userID || !statusSpan) return;

            statusSpan.textContent = "Checking...";
            analyzeBtn.disabled = true;
            infoDiv.classList.add('hidden');
            viewerContainer.classList.add('hidden');

            try {
                const response = await fetch(`${API_URL}/resume/${userID}`);
                const data = await response.json();

                if (response.ok) {
                    statusSpan.textContent = "Uploaded";
                    statusSpan.classList.replace('text-red-600', 'text-green-600');
                    document.getElementById('currentFilenameSummary').textContent = data.filename;
                    document.getElementById('currentUploadTimeSummary').textContent = data.uploaded_at ? new Date(data.uploaded_at).toLocaleDateString() : 'N/A';
                    
                    infoDiv.classList.remove('hidden');
                    analyzeBtn.disabled = false;
                    document.getElementById('aiStatus').textContent = "Status: Uploaded, Ready for analysis.";

                    // Attach handlers for viewer/download
                    const downloadUrl = API_URL + data.download_url;
                    document.getElementById('viewResumeBtn').onclick = () => {
                        const viewer = document.getElementById('resumeViewer');
                        const isHidden = viewerContainer.classList.contains('hidden');
                        viewer.src = downloadUrl;
                        viewerContainer.classList.toggle('hidden', false);
                        document.getElementById('viewResumeBtn').textContent = isHidden ? 'Hide Preview' : 'View Resume in Browser';
                    };
                    document.getElementById('downloadResumeBtn').onclick = () => window.open(downloadUrl, '_blank');

                } else {
                    // Resume Not Found (404)
                    statusSpan.textContent = "Not Uploaded";
                    statusSpan.classList.replace('text-green-600', 'text-red-600');
                    document.getElementById('aiStatus').textContent = "Status: Awaiting upload.";
                    document.getElementById('currentFilenameSummary').textContent = "None";
                    document.getElementById('currentUploadTimeSummary').textContent = "N/A";
                }
            } catch (error) {
                console.error('Resume status check error:', error);
                statusSpan.textContent = "Error";
                showMessage('Could not connect to the resume API.', 'error');
            }
        }

        window.handleResumeUpload = async function(e) {
            e.preventDefault();
            const fileInput = document.getElementById('resumeFile');
            const file = fileInput.files[0];
            
            if (!file || !currentUserId) return showMessage('Select a file.', 'error');
            if (file.size > 4 * 1024 * 1024) return showMessage('File size limit is 4MB.', 'error');

            // Clear previous AI state
            window.lastUploadedBase64 = null;
            window.lastUploadedMimeType = null;

            const reader = new FileReader();
            reader.onload = async function (event) {
                const base64Uri = event.target.result;
                
                const payload = {
                    user_id: parseInt(currentUserId),
                    filename: file.name,
                    mime_type: file.type,
                    base64_data: base64Uri // Send the full URI to the Go API 
                };

                showMessage('Uploading resume to server...', 'info');
                try {
                    const response = await fetch(`${API_URL}/resume`, { // Changed to POST /resume
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        showMessage(`Resume uploaded successfully!`, 'success');
                        updateDashboardResumeSection(currentUserId);
                        fileInput.value = '';
                    } else {
                        const data = await response.json();
                        showMessage(`Upload failed: ${data.message || 'Unknown error'}`, 'error');
                    }
                } catch (error) {
                    console.error('Resume Upload API Error:', error);
                    showMessage('Network error during upload.', 'error');
                }
            };
            reader.readAsDataURL(file);
        }

        window.analyzeResumeWithAI = async function() {
            if (!currentUserId) {
                showMessage('Please log in to analyze your resume.', 'error');
                return;
            }

            const analyzeBtn = document.getElementById('analyzeResumeBtn');
            const summaryOutput = document.getElementById('summaryContent');
            
            analyzeBtn.disabled = true;
            analyzeBtn.textContent = "Analyzing...";
            summaryOutput.innerHTML = `<p class="text-center text-blue-600">Running analysis via local API...</p>`;
            summaryOutput.classList.remove('hidden');

            const requestBody = { user_id: parseInt(currentUserId) };
            const apiUrl = `${API_URL}/resume/analyze`; 

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });
                
                const data = await response.json();

               if (response.ok) {
                    summaryOutput.innerHTML = `<pre class="whitespace-pre-wrap font-sans text-sm">${data.summary}</pre>`;
                    showMessage(`Analysis successful: ${data.Message}`, 'success');
                } else if (response.status === 404) {
                     summaryOutput.innerHTML = `<p class="text-red-600 font-bold">**Error:** Resume not found on server. Please upload your resume first!</p>`;
                     showMessage('Resume file not found for analysis.', 'error');
                } else {
                    summaryOutput.innerHTML = `<p class="text-red-600">Analysis failed: ${data.error || data.message || 'Unknown server error.'}</p>`;
                    showMessage('Analysis failed. Check dashboard for details.', 'error');
                }
            } catch (error) {
                console.error('Local Analysis API Error:', error);
                summaryOutput.innerHTML = `<p class="text-red-600">Network error during analysis. Check console and Go server logs.</p>`;
                showMessage('Network error during analysis.', 'error');
            } finally {
                analyzeBtn.textContent = "Analyze Resume (AI)";
                analyzeBtn.disabled = false;
            }
        };


        // --- DASHBOARD LOADERS (Defined in window scope for global access) ---

        window.loadJobSeekerDashboard = function() {
            const content = `
                <!-- Job Seeker Dashboard Content -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- 1. Resume Status Card -->
                    <div class="p-6 bg-yellow-50 rounded-xl border border-yellow-300 shadow-md">
                        <h3 class="text-xl font-bold text-yellow-700 mb-3 flex items-center">Resume Status</h3>
                        <div id="resumeStatusContent" class="text-sm text-gray-600 space-y-2">
                            <p>Status: <span id="currentResumeStatus" class="font-bold text-red-600">Not Uploaded</span></p>
                            <p>File: <span id="currentFilenameSummary">N/A</span></p>
                            <p>Last Update: <span id="currentUploadTimeSummary">N/A</span></p>
                        </div>
                    </div>

                    <!-- 2. Profile Views Counter (Simulated) -->
                    <div class="p-6 bg-white rounded-xl border border-gray-200 shadow-md">
                        <h3 class="text-xl font-bold text-gray-700 mb-3 flex items-center">Total Profile Views</h3>
                        <p class="text-5xl font-extrabold text-green-600"><span id="viewCount">24</span></p>
                        <p class="text-sm text-gray-500 mt-2">Companies checked your profile this month (Simulated).</p>
                    </div>

                    <!-- 3. AI Summary Card -->
                    <div class="p-6 bg-indigo-50 rounded-xl border border-indigo-300 shadow-md">
                        <h3 class="text-xl font-bold text-indigo-700 mb-3 flex items-center">AI Resume Summary</h3>
                        <div id="aiAnalysisResult" class="text-gray-700 text-sm space-y-3">
                            <p class="font-medium text-gray-500" id="aiStatus">Status: Awaiting upload.</p>
                            <button id="analyzeResumeBtn" onclick="analyzeResumeWithAI()" class="mt-2 w-full py-2 px-4 text-white bg-indigo-600 rounded-md hover:bg-indigo-700 transition-colors shadow-md text-sm disabled:opacity-50" disabled>
                                Analyze Resume (AI)
                            </button>
                            <div id="summaryContent" class="mt-4 text-sm bg-indigo-100 p-3 rounded-lg hidden"></div>
                        </div>
                    </div>
                </div>
                
                <hr class="my-8 border-gray-200">

                <!-- RESUME MANAGER SECTION -->
                <div id="resumeManagerSection" class="p-8 bg-white rounded-2xl shadow-xl border border-yellow-400/50 space-y-6">
                    <h3 class="text-2xl font-bold text-yellow-800 border-b pb-3 flex items-center">Resume Upload & Viewer</h3>
                    
                    <div id="currentResumeInfo" class="space-y-4 p-5 border border-gray-200 rounded-xl bg-white shadow-sm">
                        <h4 class="text-xl font-semibold text-gray-700">Preview & Download</h4>
                        <div class="flex space-x-4">
                            <button id="viewResumeBtn" class="py-2 px-4 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg shadow-md transition duration-150">View Resume in Browser</button>
                            <button id="downloadResumeBtn" class="py-2 px-4 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-lg shadow-md transition duration-150">Download File</button>
                        </div>
                    </div>
                    
                    <form id="resumeUploadForm" class="space-y-4 p-5 border border-yellow-200 rounded-xl bg-yellow-50 shadow-inner">
                        <h4 class="text-xl font-semibold text-gray-700">Upload New Resume (.PDF, .DOC, .DOCX)</h4>
                        <label for="resumeFile" class="block text-sm font-medium text-gray-700">Select File (Max 4MB):</label>
                        <input type="file" id="resumeFile" accept=".pdf,.doc,.docx,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document" required class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-lg shadow-sm">
                        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-5 rounded-lg shadow-md transition duration-150">
                            Upload & Replace Current Resume
                        </button>
                    </form>

                    <div id="resumeViewerContainer" class="hidden">
                        <p class="text-sm font-medium text-gray-700 mb-2">Resume Preview (Streamed from Server):</p>
                        <embed id="resumeViewer" src="" class="full-screen-viewer" type="application/pdf">
                    </div>
                </div>
            `;
            document.getElementById('dashboardContent').innerHTML = content;
            // Re-attach listeners for the JS Seeker dashboard
            document.getElementById('resumeUploadForm').addEventListener('submit', window.handleResumeUpload);
            updateDashboardResumeSection(currentUserId);
        }

        window.loadCompanyDashboard = function() {
            const paidText = currentIsPaidMember ? "PREMIUM: Access to full contact details." : "FREE TIER: Contact details are masked.";
            const upgradeLink = currentIsPaidMember ? '' : `<p class="text-sm text-red-500 font-bold mt-4">Upgrade your plan to view contact details.</p>`;
            
            const content = `
                <!-- Company Dashboard Content -->
                <div class="space-y-8">
                    <!-- Job Listing Management -->
                    <div class="p-8 bg-white rounded-2xl shadow-xl border border-indigo-400/50 space-y-6">
                        <h3 class="text-2xl font-bold text-indigo-700 border-b pb-3">Job Management (CRUD)</h3>
                        <p class="text-sm text-gray-600">Manage job descriptions and track applicant flow.</p>
                        <div class="grid grid-cols-2 gap-4">
                            <button class="py-2 px-4 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700">
                                + Create New Job Listing
                            </button>
                            <button class="py-2 px-4 bg-gray-300 text-gray-800 font-semibold rounded-lg shadow-md hover:bg-gray-400">
                                View Active Listings (4)
                            </button>
                        </div>
                    </div>

                    <!-- Candidate Search Section -->
                    <div class="p-8 bg-white rounded-2xl shadow-xl border border-green-400/50 space-y-6">
                        <h3 class="text-2xl font-bold text-green-700 border-b pb-3">Candidate Search & Matching</h3>
                        <p class="text-sm text-gray-600">${paidText}</p>
                        
                        <form id="candidateSearchForm" class="space-y-4">
                            <input type="text" id="searchKeywords" placeholder="Enter required skills (e.g., Kubernetes, Python, 5 years)" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3" required>
                            <button type="submit" class="w-full py-2 px-4 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700">
                                Search Matching Resumes (Elastic)
                            </button>
                        </form>

                        <div id="candidateResults" class="mt-6 space-y-4">
                            <h4 class="font-bold text-gray-700">Top Matches (Simulated):</h4>
                            <!-- Simulated Match 1 -->
                            <div class="p-4 border rounded-lg bg-gray-50 space-y-2">
                                <p class="font-semibold text-lg">Candidate 1: Senior DevOps Engineer</p>
                                <p class="text-sm text-gray-700">**Skills:** Go, Docker, AWS, Terraform.</p>
                                ${currentIsPaidMember ? `
                                    <p class="text-sm text-green-700 font-bold">**Contact:** John Doe, 555-1234, john.d@email.com</p>
                                ` : `<p class="text-sm text-red-600 font-bold">Contact: [Masked: Upgrade to Premium]</p>`}
                            </div>
                            <!-- Simulated Match 2 -->
                            <div class="p-4 border rounded-lg bg-gray-50 space-y-2">
                                <p class="font-semibold text-lg">Candidate 2: Full Stack Developer</p>
                                <p class="text-sm text-gray-700">**Skills:** React, Python, AWS Lambda.</p>
                                ${currentIsPaidMember ? `
                                    <p class="text-sm text-green-700 font-bold">**Contact:** Alice Smith, 555-9876, alice.s@email.com</p>
                                ` : `<p class="text-sm text-red-600 font-bold">Contact: [Masked: Upgrade to Premium]</p>`}
                            </div>
                            ${upgradeLink}
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('dashboardContent').innerHTML = content;
             // Attach form handler (simulated search)
            document.getElementById('candidateSearchForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const keywords = document.getElementById('searchKeywords').value;
                const resultsDiv = document.getElementById('candidateResults');
                resultsDiv.innerHTML = `<p class="text-center text-blue-600">Searching for resumes matching "${keywords}"...</p>`;
                
                // Simulate fetching and displaying tiered data
                setTimeout(() => {
                    const paidContact = currentIsPaidMember ? `<p class="text-sm text-green-700 font-bold">**Contact:** John Doe, 555-1234, john.d@email.com</p>` : `<p class="text-sm text-red-600 font-bold">Contact: [Masked: Upgrade to Premium]</p>`;
                    resultsDiv.innerHTML = `
                        <h4 class="font-bold text-gray-700">Top Matches for "${keywords}":</h4>
                        <div class="p-4 border rounded-lg bg-gray-50 space-y-2">
                            <p class="font-semibold text-lg">Candidate 3: Senior Product Manager</p>
                            <p class="text-sm text-gray-700">**Skills:** Product Management, Jira, Agile.</p>
                            ${paidContact}
                        </div>
                        ${upgradeLink}
                    `;
                }, 1500);
            });
        }
        
        window.loadAdvertiserDashboard = function() {
            const content = `
                <!-- Advertiser Dashboard Content -->
                <div class="p-8 bg-white rounded-2xl shadow-xl border border-purple-400/50 space-y-6">
                    <h3 class="text-2xl font-bold text-purple-700 border-b pb-3">Campaign Management Console</h3>
                    <p class="text-sm text-gray-600">Manage ad placements targeting Job Seekers and Companies.</p>
                    <div class="grid grid-cols-2 gap-4 text-center">
                        <div class="p-4 bg-purple-50 rounded-lg border">
                            <p class="text-4xl font-extrabold text-purple-600">5</p>
                            <p class="text-sm text-gray-700">Active Campaigns</p>
                        </div>
                        <div class="p-4 bg-purple-50 rounded-lg border">
                            <p class="text-4xl font-extrabold text-purple-600">8.2%</p>
                            <p class="text-sm text-gray-700">Average CTR</p>
                        </div>
                    </div>
                    <button class="w-full py-2 px-4 bg-purple-600 text-white font-semibold rounded-lg shadow-md hover:bg-purple-700">
                        View Analytics & Reports
                    </button>
                </div>
            `;
            document.getElementById('dashboardContent').innerHTML = content;
        }

        // Initial setup run
        document.addEventListener('DOMContentLoaded', checkAuth);
    </script>
</body>
</html>
